# 08 — Diagnostics

**Source:** Compiled from `src/docs/ARCHITECTURE_AUTOGEN/SYSTEM_DIAGNOSTICS.generated.md`, `PIPELINE_DIAGNOSTIC_TRACE_REPORT.md`, `src/system-reports/summaries/`, `src/docs/RUNTIME/CURSOR_SYSTEM_FILES_UPDATE_PROTOCOL.md`.

---

## System diagnostics report (screens / scans)

- **Screens found (example):** apps, dashboard.json, diagnostics, websites.
- **Planned extensions:** Registry, behavior, layout, state scans (TODO in generator output).
- **Source:** system-diagnostics.generator.ts output → SYSTEM_DIAGNOSTICS.generated.md. This pack reads that output; does not regenerate it.

---

## Pipeline debug flow

- **Pipeline stages:** action (event received) → behavior (verb matched) → state (dispatchState) → layout (override applied) → render (pass).
- **Pipeline debug store:** src/devtools/pipeline-debug-store.ts; pipelineStageTrace (src/engine/debug/pipelineStageTrace.ts) records stages.
- **InteractionTracerPanel:** Document-level handler for click/change/input; setLastEvent; reads getLastPipelineTrace(). **Known issue:** Clearing trace in document handler before action event dispatches can show action FAIL / empty trace; fix: clear trace at start of behavior-listener "action" callback, not in document handler.
- **Active node / section row:** Active node id from DOM (e.g. section-layout-preset-${sectionKey}). Section rows keyed by section id (e.g. features_section). Normalize: if activeId is section-layout-preset-<sectionKey>, use sectionKey for row lookup (same for card-layout-preset-, organ-internal-layout-).

---

## Pipeline diagnostic trace (layout dropdown example)

- **Observed:** Section layout dropdown (e.g. features_section → "content-narrow"); state shows update; section table showed different layout (e.g. features-grid-3).
- **Causes traced:** (1) Active node id = section-layout-preset-features_section vs section rows keyed by features_section — normalize control ids to section keys. (2) Trace cleared on document click/change before action handler runs — move resetPipelineTrace to start of action handler in behavior-listener. (3) behavior FAIL "No behavior matched" for state:update is expected — state mutation is via dispatchState in action listener, not contract verb. (4) Section table layout vs state: ensure section table reads resolved layout from same source as renderer (override → node.layout → template default).
- **Files:** InteractionTracerPanel.tsx (normalize activeId; do not reset trace in document handler); behavior-listener.ts (resetPipelineTrace at start of action handler).

---

## Failure tracking logic

- **Behavior listener:** Warns on "[action] Missing action name", "[navigate] Missing destination", "[behavior-runner] failed", "[action] Unhandled action". No silent swallows on primary path; throw, warn, or documented return.
- **State/store:** Errors surface via return/log; screen-loader and API return 404 or throw as appropriate.
- **Dev-only:** evaluateCompatibility console.debug; behavior-listener console.log/groupCollapsed; runtime-decision-trace; diagnostics panels — gated by dev/build flags; do not change production paths.

---

## System reports and summaries

- **Snapshots:** src/system-reports/snapshots/<timestamp>/SYSTEM_SUMMARY.md — file count, runtime vs generated ratio, top central files, suspected duplication zones, trunk candidates, risk areas (large files).
- **Summaries:** src/system-reports/summaries/AI_SNAPSHOT_PACK.md, AI_SNAPSHOT_PACK.json, LATEST_CHANGE_SUMMARY.md — spine, contracts, critical integration map, debug recipe.
- **Usage:** Read these for diagnostics and pipeline proof; do not delete or replace. Generators (generate-reachability-report.ts, system-diagnostics.generator.ts) remain the source of truth; this pack compiles from their outputs.

---

## Update protocol (docs only — no rescan here)

- **CURSOR_SYSTEM_FILES_UPDATE_PROTOCOL.md:** When to run: after major refactors, new subsystems, or layout/behavior/state changes; when autogenerated docs feel out of date; before large planning or execution work.
- **Steps (execute in order):** (1) Scan repository source (lightweight structural pass): entry points, runtime pipeline stages, layout resolution flow, behavior→state wiring, registry definitions, data flow into renderer. (2) Re-derive current contracts in memory only: runtime pipeline, layout resolution order, behavior/state wiring, registry map, data flow. Do NOT regenerate any docs yet. (3) Compare against existing autogenerated docs (ARCHITECTURE_AUTOGEN, SYSTEM_MAP_AUTOGEN, SYSTEM_INTELLIGENCE subfolder); for each doc compare described contracts to code-derived picture; identify only meaningful architectural differences. Do not rewrite unchanged sections. (4) Update only changed sections; diff-first, not full regeneration.
- **This consolidation pack:** Does not run scans or generators. It only reads existing docs and system-reports and compiles into the master files in system-architecture/.

---

## Dev-only surfaces (do not change production)

- **runtime-decision-trace:** Dev tooling for decision trace; not on production code path.
- **Diagnostics:** Dev logging (e.g. evaluateCompatibility console.debug, behavior-listener console.log/groupCollapsed), dev-only panels; gated by dev/build flags or not invoked in production.
- **Pipeline trace / InteractionTracerPanel:** resetPipelineTrace, getLastPipelineTrace, setLastEvent — for debugging; normalize control ids (section-layout-preset-*, card-layout-preset-*, organ-internal-layout-*) for section row lookup.
- Production behavior and state flow are unchanged by these surfaces.

---

## Browser + CSS proof (Playwright-optional snippet)

- **Section identity:** Inspect data-section-id on section wrapper (section.compound); data-section-layout and data-container-width on layout wrapper (LayoutMoleculeRenderer).
- **Node identity:** data-node-id on node wrappers (json-renderer); in dev data-section-debug may show sectionKey, containerWidth.
- **Optional Playwright snippet (not executed):** Capture screenshot; computed style of section wrapper; DOM attributes sectionKey, layoutPreset, containerWidth from data-section-id, data-section-layout, data-container-width selectors. See AI_SNAPSHOT_PACK.md Debug recipe.
