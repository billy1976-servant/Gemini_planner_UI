# 01 — System Overview

**Source:** Compiled from `src/docs/ARCHITECTURE_AUTOGEN/`, `src/docs/SYSTEM_MAP_AUTOGEN/`, `src/system-reports/summaries/`. No regeneration; read-only consolidation.

---

## What the system is

HiSense is a **JSON-driven UI system**: screens and skins are defined in JSON (blueprint + content), compiled to runtime trees, and rendered by a single engine (JsonRenderer + Registry). Logic and behavior are wired via CustomEvents and an append-only state log. The codebase also includes a **site compiler** (raw snapshot → normalized → schema) and **skin pipeline** (skin JSON → composeScreen → shells → JsonRenderer).

---

## Spine model (authoritative)

Flow: **JSON Screen → Engines → State → Layout → Renderer → DOM**

| Stage | Key files |
|-------|-----------|
| **JSON Screen** | `src/app/page.tsx` (entry; searchParams, loadScreen, resolveLandingPage); `src/app/api/screens/[...path]/route.ts` (GET handler); `src/engine/core/screen-loader.ts` (loadScreen, dispatchState state:currentView if json.state) |
| **Engines** | page.tsx (assignSectionInstanceKeys, expandOrgansInDocument, applySkinBindings, composeOfflineScreen); palette-bridge (applySkinBindings); behavior-listener (action → state:* \| navigate \| runBehavior \| interpretRuntimeVerb); behavior-runner; engine-bridge |
| **State** | `src/state/state-store.ts` (dispatchState, log, persist/rehydrate, listeners); `src/state/state-resolver.ts` (deriveState: currentView, journal, values, layoutByScreen, scans, interactions) |
| **Layout** | `src/layout/resolver/layout-resolver.ts` (resolveLayout, getDefaultSectionLayoutId); `src/layout/index.ts`; `src/engine/core/layout-store.ts`; `src/lib/layout/molecule-layout-resolver.ts` |
| **Renderer** | `src/engine/core/json-renderer.tsx` (JsonRenderer, renderNode, applyProfileToNode, Registry); `src/engine/core/registry.tsx`; section.compound.tsx; LayoutMoleculeRenderer.tsx |
| **DOM** | data-node-id, data-section-id, data-section-layout, data-container-width (json-renderer, LayoutMoleculeRenderer, section.compound) |

---

## Major layers

- **Primary path:** Next.js `page.tsx` → loadScreen (TSX or JSON) → document prep (instance keys, organ expand, skin bindings, compose) → JsonRenderer → Registry → Section/LayoutMoleculeRenderer → DOM.
- **Secondary paths:** renderFromSchema, GeneratedSiteViewer, SiteSkin — used for site/generated-websites or TSX/flow screens; not on main JSON screen path.
- **Blueprint boundary:** Compiler produces app.json + content.manifest.json under `src/apps-offline/apps/<appPath>/`. No blueprint script in runtime; no runtime layout IDs from blueprint. Layout resolution is entirely runtime (override store → node.layout → template default).
- **Scripts boundary:** Scripts under `src/scripts/` (blueprint, docs generators, reachability) are build-time or one-off. No script is imported by app/engine/state/layout at runtime.

---

## Refactor direction

- **Current goal:** Ship shippable website/app skins from the existing JSON→Layout→Regions→Molecules pipeline; lock docs, polish visual shells, connect ripper→skin output, wire behavior/logic — without refactoring engines, molecules, or renderer.
- **Documentation protocol:** CURSOR_SYSTEM_FILES_UPDATE_PROTOCOL.md — diff-first updates to autogenerated docs; no full regeneration without comparing against code.
- **Boundaries:** Layout ≠ Logic ≠ State ≠ Behavior ≠ Blueprint ≠ Organs ≠ Registry; no cross-boundary writes (see BOUNDARY_SEPARATION_CHECKLIST).

---

## Where things live

| What | Where |
|------|--------|
| Screens (JSON) | `src/apps-offline/apps/<category>/<folder>/` (app.json). Served via `/api/screens/*`. |
| Screens (TSX) | `src/screens/`; loadScreen("tsx:...") returns descriptor, no fetch. |
| Logic/behavior | behavior-listener, behavior-runner, state-store, state-resolver, runtime-verb-interpreter, action-runner, action-registry. |
| Layout | layout/resolver, layout-store, section-layout-preset-store, organ-internal-layout-store; page-layouts, templates, component-layouts, compatibility. |
| Contracts | `src/contracts/` (ENGINE_LAWS, PARAM_KEY_MAPPING, BLUEPRINT_UNIVERSE, CONTENT_DERIVATION, JSON_SCREEN_CONTRACT). |
