# Architecture Status - JSON-Driven Decision Engine

## âœ… Complete

### 1. Engine Viewer Screen
- **File**: `src/screens/tsx-screens/engine-viewer.tsx`
- **Status**: âœ… Complete
- **Features**:
  - Loads one card in isolation
  - Auto-discovers JSON flows from `src/logic/content/flows/` directory
  - Dropdown selector with no hard-coded options
  - Clean state reinitialization on flow switch
  - Pure UI skin - zero business logic

### 2. Canonical Content Contract
- **Status**: âœ… Enforced
- **All content in JSON**:
  - Questions: `steps[].title`, `steps[].body`
  - Choices: `steps[].choices[]` with `id`, `label`, `kind`
  - Signals: `choices[].outcome.signals[]`
  - Blockers: `choices[].outcome.blockers[]`
  - Opportunities: `choices[].outcome.opportunities[]`
  - Severity: `choices[].outcome.severity`
  - Next-step routing: `routing.rules[]` (content-driven)
  - Copy: All text in JSON, never in TSX
  - Outputs: Generated by engines from JSON outcomes

### 3. DecisionState Structure
- **File**: `src/logic/engines/decision-types.ts`
- **Status**: âœ… Complete
- **Contains**:
  - `signals: string[]` - Semantic signals from choices
  - `blockers: string[]` - Items preventing progress
  - `opportunities: string[]` - Items increasing value
  - `recommendedNextSteps: RecommendedStep[]` - Engine-generated recommendations
  - `context: Record<string, any>` - User/business context
  - `outputs.immediateView: UIBlock[]` - Mobile-first, compressed
  - `outputs.expandedView: ExpandedBlock[]` - Accordion/explainer
  - `outputs.exportView: DocumentBlock[]` - Print/PDF ready
  - `outputs.exportArtifacts: ExportArtifact[]` - Checklist, summary, action plan

### 4. Multi-Format Delivery
- **Status**: âœ… Implemented
- **ImmediateView** (`buildImmediateView`):
  - Mobile-first, compressed format
  - Priority: Blockers â†’ Opportunities â†’ Signals
  - Severity-based styling
- **ExpandedView** (`buildExpandedView`):
  - Accordion/explainer format
  - Expandable sections for signals, blockers, opportunities
  - Detailed explanations
- **ExportView** (`buildExportView`):
  - Print/PDF ready format
  - Summary, step-by-step analysis, action items
- **ExportArtifacts** (`generateExportArtifacts`):
  - Checklist (text format)
  - Summary (JSON format)
  - Action Plan (text format)

### 5. Content-Only Routing Layer
- **File**: `src/logic/engines/flow-router.ts`
- **Status**: âœ… Complete
- **Features**:
  - Engine decides next step based on signals (not UI)
  - Routing rules defined in JSON: `routing.rules[]`
  - Supports: `skip`, `goto`, `repeat` actions
  - Evaluates: `signals`, `blockers`, `opportunities`
  - Default: Linear progression if no rules match
- **Integration**: `EducationCard` uses `resolveNextStep()` for step progression

### 6. Auto-Discovery System
- **File**: `src/app/api/flows/list/route.ts`
- **Status**: âœ… Complete
- **Features**:
  - Scans `src/logic/content/flows/` directory
  - Returns flow metadata (id, title, stepCount)
  - No hard-coded registry
  - Drop new JSON file â†’ appears automatically

## ğŸ”§ Extensible (Extension Points)

### 1. Business Profiles
- **File**: `src/logic/config/business-profiles.ts`
- **Extension Point**: Add new profiles to `BUSINESS_PROFILES` object
- **Usage**: Content labels, explanations, export sections
- **Status**: Ready for multi-business support

### 2. Routing Rules
- **File**: JSON flow files (`routing.rules[]`)
- **Extension Point**: Add rules to any flow JSON
- **Capabilities**: Skip steps, goto specific steps, repeat steps
- **Status**: Fully functional, can add complex conditions

### 3. Export Artifacts
- **File**: `src/logic/engines/decision-engine.ts` â†’ `generateExportArtifacts()`
- **Extension Point**: Add new artifact types
- **Current Types**: `checklist`, `summary`, `action-plan`
- **Status**: Can add `contractor-summary`, `homeowner-plan`, etc.

### 4. View Resolvers
- **File**: `src/logic/runtime/view-resolver.ts`
- **Extension Point**: Enhance with business-specific content
- **Status**: Basic implementation, ready for content enhancement

### 5. Signal Processing
- **File**: `src/logic/engines/decision-engine.ts` â†’ `extractSignalFromText()`
- **Extension Point**: Add NLP or pattern matching
- **Status**: Basic pattern matching, ready for enhancement

## ğŸš« Intentionally Deferred

### 1. Cross-User Learning
- **Status**: Not implemented
- **Reason**: Deterministic engine requirement
- **Extension Point**: Can add analytics layer without changing engine

### 2. Analytics Optimization
- **Status**: Not implemented
- **Reason**: Zero business logic in TSX requirement
- **Extension Point**: Can add analytics hooks in engine layer

### 3. Ad Logic
- **Status**: Not implemented
- **Reason**: Not part of decision engine scope
- **Extension Point**: Can add as separate layer

### 4. PDF Generation
- **Status**: Export artifacts are data-only
- **Reason**: Focus on data structure, not rendering
- **Extension Point**: Add PDF renderer that consumes `exportArtifacts`

### 5. Real-Time Collaboration
- **Status**: Not implemented
- **Reason**: Single-user deterministic engine
- **Extension Point**: Can add state sync layer

## ğŸ“Š Architecture Principles

### âœ… Enforced
1. **Zero Business Logic in TSX**: All logic in engines, TSX is pure UI skin
2. **JSON-Driven**: All content, routing, outcomes in JSON files
3. **Deterministic**: Same inputs â†’ same outputs, no randomness
4. **Canonical State**: One `DecisionState` per run, aggregated from all outcomes
5. **Multi-Format**: Same content â†’ multiple views (immediate, expanded, export)
6. **Content-Only Routing**: Engine decides next step, not UI

### ğŸ”„ Preserved
- Existing `EducationCard` behavior
- Existing `decision-engine` aggregation logic
- Existing `business-profiles` structure
- Existing state management (`engine-bridge`, `state-store`)

## ğŸ“ File Structure

```
src/
â”œâ”€â”€ logic/
â”‚   â”œâ”€â”€ content/
â”‚   â”‚   â”œâ”€â”€ flows/
â”‚   â”‚   â”‚   â”œâ”€â”€ flow-a.json (with routing rules)
â”‚   â”‚   â”‚   â”œâ”€â”€ flow-b.json
â”‚   â”‚   â”‚   â””â”€â”€ flow-c.json
â”‚   â”‚   â””â”€â”€ flow-loader.ts (auto-discovery)
â”‚   â”œâ”€â”€ engines/
â”‚   â”‚   â”œâ”€â”€ decision-engine.ts (aggregation + multi-format)
â”‚   â”‚   â”œâ”€â”€ decision-types.ts (canonical types)
â”‚   â”‚   â””â”€â”€ flow-router.ts (content-driven routing)
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ business-profiles.ts (multi-business support)
â”‚   â””â”€â”€ runtime/
â”‚       â”œâ”€â”€ view-resolver.ts (multi-format resolvers)
â”‚       â””â”€â”€ export-resolver.ts (export generation)
â”œâ”€â”€ screens/
â”‚   â””â”€â”€ tsx-screens/
â”‚       â”œâ”€â”€ engine-viewer.tsx (isolated card viewer)
â”‚       â””â”€â”€ onboarding/
â”‚           â””â”€â”€ cards/
â”‚               â””â”€â”€ EducationCard.tsx (uses routing engine)
â””â”€â”€ app/
    â””â”€â”€ api/
        â””â”€â”€ flows/
            â”œâ”€â”€ list/route.ts (auto-discovery)
            â””â”€â”€ [flowId]/route.ts (flow loader)
```

## ğŸ¯ Success Criteria

- âœ… Engine Viewer loads one card in isolation
- âœ… Auto-discovers JSON flows (no hard-coded options)
- âœ… All content in JSON (questions, choices, signals, routing, copy)
- âœ… One DecisionState per run with all required fields
- âœ… Multi-format delivery (ImmediateView, ExpandedView, ExportView)
- âœ… Content-only routing (engine decides next step)
- âœ… Zero business logic in TSX
- âœ… Extension points for future features
- âœ… Existing behavior preserved

## ğŸš€ Next Steps (Optional)

1. **Add more business profiles** to `business-profiles.ts`
2. **Enhance routing rules** in JSON flows (complex conditions)
3. **Add PDF renderer** for `exportArtifacts`
4. **Add analytics hooks** (without changing engine logic)
5. **Add more export artifact types** (contractor-summary, homeowner-plan)
